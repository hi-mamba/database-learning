

# 怎么给字符串字段加索引

> 索引选取的越长，`占用的磁盘空间就越大`，相同的数据页能放下的索引值就越少，搜索的效率也就会越低。

也就是说使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加太多的查询成本。

使用前缀索引就用不上覆盖索引对查询性能的优化了

## 什么方法能够确定我应该使用多长的前缀呢？

我们在建立索引时关注的是区分度，区分度越高越好。因为区分度越高，意味着重复的键值越少。
因此，我们可以通过统计索引上有多少个不同的值来判断要使用多长的前缀。

你可以使用下面这个语句，算出这个列上有多少个不同的值：
```mysql
mysql> select count(distinct email) as L from SUser;

```

然后，依次选取不同长度的前缀来看这个值，比如我们要看一下4~7个字节的前缀索引，可以用这个语句：

```mysql
mysql> select 
  count(distinct left(email,4)）as L4,
  count(distinct left(email,5)）as L5,
  count(distinct left(email,6)）as L6,
  count(distinct left(email,7)）as L7,
from SUser;
              
```
当然，使用前缀索引很可能会损失区分度，所以你需要预先设定一个可以接受的损失比例，比如5%。然后，在返回的L4~L7中，
找出不小于 L * 95%的值，假设这里L6、L7都满足，你就可以选择前缀长度为6。

## 前缀索引对覆盖索引的影响

使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是你在选择是否使用前缀索引时需要考虑的一个因素。

## 总结

- 直接创建完整索引，这样可能比较占用空间；

- 创建前缀索引，节省空间，但会增加查询扫描次数，并且不能使用覆盖索引；

- 倒序存储，再创建前缀索引，用于绕过字符串本身前缀的区分度不够的问题；

- 创建hash字段索引，查询性能稳定，有额外的存储和计算消耗，跟第三种方式一样，都不支持范围扫描。


## 问题

如果你在维护一个学校的学生信息数据库，学生登录名的统一格式是”学号@gmail.com", 
而学号的规则是：十五位的数字，其中前三位是所在城市编号、第四到第六位是学校编号、
第七位到第十位是入学年份、最后五位是顺序编号。

系统登录的时候都需要学生输入登录名和密码，验证正确后才能继续使用系统。
就只考虑登录验证这个行为的话，你会怎么设计这个登录名的索引呢？

答案：
由于这个学号的规则，无论是正向还是反向的前缀索引，重复度都比较高。因为维护的只是一个学校的，
因此前面6位（其中，前三位是所在城市编号、第四到第六位是学校编号）其实是固定的，邮箱后缀都是@gamil.com，
因此可以只存入学年份加顺序编号，它们的长度是9位。

而其实在此基础上，可以用数字类型来存这9位数字。比如201100001，这样只需要占4个字节。其实这个就是一种hash，
只是它用了最简单的转换规则：字符串转数字的规则，而刚好我们设定的这个背景，可以保证这个转换后结果的唯一性。

评论区中，也有其他一些很不错的见解。

评论用户@封建的风 说，一个学校的总人数这种数据量，50年才100万学生，这个表肯定是小表。为了业务简单，
直接存原来的字符串。这个答复里面包含了“优化成本和收益”的思想，我觉得值得at出来。

@小潘 同学提了另外一个极致的方向。如果碰到表数据量特别大的场景，通过这种方式的收益是很不错的。

