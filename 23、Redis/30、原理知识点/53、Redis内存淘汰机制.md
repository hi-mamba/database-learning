##### [原文3](https://www.jianshu.com/p/ad8f35c2c0d0)

##### [原文2](https://blog.csdn.net/sinat_34341162/article/details/84393110)

##### [原文](http://www.redis.cn/articles/20181020002.html)

# Redis内存淘汰机制（包括LRU原理和实现）

## 概述

在 Redis 中，允许用户设置最大使用内存大小 `server.maxmemory`，在内存限定的情况下是很有用的。
譬如，在一台 8G 机子上部署了 4 个 Redis 服务点，每一个服务点分配 1G 的内存大小，减少内存紧张的情况，
由此获取更为稳健的服务。Redis 内存数据集大小上升到一定大小的时候，就会施行`数据淘汰策略`。

## 背景

Redis采用的过期策略是`定期删除+惰性删除`，但由于定期删除的随机性和惰性删除的`被动性`，
仍然可能出现大量过期key堆积在内存里，导致redis的内存快耗尽。

为了避免这种情况，redis的内存数据集大小上升到一定大小的时候，就会开启`内存淘汰功能`。
 
## Redis 提供 6 种数据淘汰策略供用户选择

1. volatile-lru：从已设置过期时间的数据集（server.db[i].expires）中挑选最近最少使用 的数据淘汰

2. volatile-ttl：从已设置过期时间的数据集（server.db[i].expires）中挑选将要过期的数 据淘汰

3. volatile-random：从已设置过期时间的数据集（server.db[i].expires）中任意选择数据 淘汰

4. allkeys-lru：从数据集（server.db[i].dict）中挑选最近最少使用的数据淘汰

5. allkeys-random：从数据集（server.db[i].dict）中任意选择数据淘汰

6. no-enviction（驱逐）：禁止驱逐数据 ，不淘汰数据，直接报错


- 1，版本不同，默认的策略不同

在`2.8.13的版本里，默认是 noeviction`，在3.2.3版本里`默认是 volatile-lru`

其中allkeys-lru策略是最推荐，最常使用的。

- 2，volatile-lru、volatile-ttl、volatile-random这几种只对设置了过期时间的key有效，不会淘汰没有设置过期时间的key

- 3，与是否设置持久化无关

- 4，测试volatile-lru测量，在插入有过期时间的key时，如果达到了maxmemory值，就会对老的key进行淘汰，插入新值

- 5，如果设置为noeviction或者key没有过期时间，当达到最大内存值时就会直接报错

### 下面看看几种策略的适用场景： 
- allkeys-lru：如果我们的应用对缓存的访问符合幂律分布（也就是存在相对热点数据），
或者我们不太清楚我们应用的缓存访问分布状况，我们可以选择allkeys-lru策略。

- allkeys-random：如果我们的应用对于缓存key的访问概率相等，则可以使用这个策略。·         

- volatile-ttl：这种策略使得我们可以向Redis提示哪些key更适合被eviction。

Redis 确定驱逐某个键值对后，会删除这个数据，并将这个数据变更消息发布到本地（AOF 持久化）和从机（主从连接）。

### 设置方式   
```xml
config set maxmemory-policy volatile-lru

```

## LRU

LRU缓存的思想
- 固定缓存大小，需要给缓存分配一个固定的大小。
- 每次读取缓存都会改变缓存的使用时间，将缓存的存在时间重新刷新。
- 需要在缓存满了后，将最近最久未使用的缓存删除，再添加最新的缓存。

## LRU 数据淘汰机制

每一个 Redis 对象都会设置相应的 lru，即最近访问的时间。
可以想象的是，每一次访问数据的时候，会更新 redisObject.lru。

淘汰原理：
> 在数据集中随机挑选几个键值对，取出其中 lru 最大的键值对淘汰。
所以，你会发现，Redis 并不是保证取得所有数据集中最近最少使用（LRU）的键值对，而只是随机挑选的几个键值对中的。


## TTL 数据淘汰机制
Redis 数据集数据结构中保存了键值对过期时间的表，即 redisDb.expires，在使用 SET 命令的时候，
就有一个键值对超时时间的选项。
 
淘汰原理：
> 从过期时间 redisDB.expires 表中随机挑选几个键值对，取出其中 ttl 最大的键值对淘汰。
同样你会发现，Redis 并不是保证取得所有过期时间的表中最快过期的键值对，而只是随机挑选的几个键值对中的。

## 什么时候开始淘汰数据

Redis 每服务客户端执行一个命令的时候，会`检测使用的内存是否超额`。如果超额，即进行数据淘汰。

数据淘汰策略其实只是其中一种数据的删除策略，从大方向上看，应该看看redis数据删除策略

## 数据删除策略有三种：

1. 被动删除：只有key被操作时(如GET)，Redis才会被动检查该key是否过期，如果过期则删除之并且返回NIL。

2. 主动删除：定期删除过期的数据，可以配置

3. 当前已用内存超过maxmemory限定时，触发`数据淘汰策略`
