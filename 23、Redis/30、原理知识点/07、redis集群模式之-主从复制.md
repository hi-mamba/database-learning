
## [原文1](https://www.cnblogs.com/kevingrace/p/5685332.html)

# redis集群模式之-主从复制

## 简介

[redis三种集群模式](../03、基础知识/30、redis三种集群模式.md)

## 实现原理

## 选举
主从是在配置文件中写死的,  
slave服务器redis.conf 配置，master服务不需要配置这两个.
```xml
 slaveof 172.168.10.251  6379                     #设置主服务的IP及端口
 slave-read-only         yes                      #配置从机是否只读
```
配置好之后，master先启动
## 故障转移

我们不难看出Redis在主从模式下，必须保证主节点不会宕机——一旦主节点宕机，
其它节点不会竞争称为主节点，此时，Redis将丧失写的能力。这点在生产环境中，是致命的。

> 当采用 Master-Slave 的高可用方案时候，如果 Master 宕机之后，`想自动切换`，可以`考虑使用哨兵模式`。
哨兵模式其实是在主从模式的基础上工作的。

### 从Redis宕机

a) 这个相对而言比较简单，在Redis中从库重新启动后会自动加入到主从架构中，自动完成同步数据；

b) 问题？ 如果从库在断开期间，主库的变化不大，从库再次启动后，主库依然会将所有的数据做RDB操作吗？还是增量更新？（从库有做持久化的前提下）
 
 不会的，因为在`Redis2.8版本后就实现了，主从断线后恢复的情况下实现增量复制`。

### 主Redis宕机

a) 这个相对而言就会复杂一些，需要以下2步才能完成
- 第一步，在从数据库中执行SLAVEOFNO ONE命令，断开主从关系并且提升为主库继续服务；  
- 第二步，将主库重新启动后，执行SLAVEOF命令，将其设置为其他库的从库，这时数据就能更新回来；

b)  这个手动完成恢复的过程其实是比较麻烦的并且容易出错，有没有好办法解决呢？当前有的，Redis提供的哨兵（sentinel）的功能。
 

## 同步原理（复制原理）

### 全量同步
Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下：

-  从服务器连接主服务器，发送SYNC命令；
-  主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；
-  主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；
-  从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；
-  主服务器快照发送完毕后开始向从服务器发送`缓冲区中的写命令`；
-  从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；

![](../../../images/redis/cluster/redis_master_slave_sync_data.png)  
完成上面几个步骤后就完成了从服务器数据初始化的所有操作，从服务器此时可以接收来自用户的读请求。

### 增量同步
Redis增量复制是指Slave初始化后开始正常工作时`主服务器`发生的`写操作同步`到`从服务器`的过程。
增量复制的过程主要是主服务器每执行一个写命令就会向`从服务器发送`相同的写命令，从服务器接收并执行收到的写命令。
 
### Redis主从同步策略
主从刚刚连接的时候，进`行全量同步`；全同步结束后，进行`增量同步`。当然，如果有需要，slave 在任何时候都可以发起全量同步。
redis 策略是，无论如何，首先会`尝试进行增量同步`，如不成功，要求从机进行`全量同步`。
 
**需要注意**：`如果多个Slave断线了，需重启时，因为只要Slave启动，就会发送sync请求和主机全量同步，
当多个同时出现的时候，可能会导致Master IO剧增宕机。`

Redis`主从复制`的配置十分简单，它可以使从服务器是主服务器的完全拷贝。需要清楚知道Redis主从复制的几点重要内容：

- 1）Redis使用`异步复制`。但从Redis 2.8开始，从服务器会`周期性的应答`从复制流中处理的数据量。

- 2）一个主服务器可以有多个从服务器。

- 3）从服务器也可以接受其他从服务器的连接。除了多个从服务器连接到一个主服务器之外，多个从服务器也可以连接到一个从服务器上，形成一个图状结构。

- 4）Redis主从复制`不阻塞主服务器端`。也就是说当若干个从服务器在进行初始同步时，主服务器仍然可以处理请求。

- 5）主从复制也不阻塞从服务器端。当从服务器进行初始同步时，它使用旧版本的数据来应对查询请求，
假设你在redis.conf配置文件是这么配置的。否则的话，你可以配置当复制流关闭时让从服务器给客户端返回一个错误。
但是当初始同步完成后，需删除旧数据集和加载新的数据集，在这个短暂时间内，从服务器会阻塞连接进来的请求。

- 6）主从复制可以用来增强扩展性，使用多个从服务器来处理只读的请求（比如，繁重的排序操作可以放到从服务器去做），也可以简单的用来做数据冗余。

- 7）使用主从复制可以为主服务器免除把数据写入磁盘的消耗：在主服务器的redis.conf文件中配置“避免保存”（注释掉所有“保存“命令），
然后连接一个配置为“进行保存”的从服务器即可。但是这个配置要确保主服务器不会自动重启（要获得更多信息请阅读下一段）
