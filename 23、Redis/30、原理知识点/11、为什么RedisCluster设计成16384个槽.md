
<https://zhuanlan.zhihu.com/p/99037321>

<https://github.com/antirez/redis/issues/2576>

# 为什么RedisCluster设计成16384个槽

- 如果槽位为65536，发送心跳信息的消息头达8k，`发送的心跳包过于庞大`。

- redis的集群主节点数量基本不可能超过1000个。

- 槽位越小，节点少的情况下，压缩率高

## 详情

- 如果槽位为65536，发送心跳信息的消息头达8k，`发送的心跳包过于庞大`。
> 如上所述，在消息头中，最占空间的是 myslots[CLUSTER_SLOTS/8]。 
> 当槽位为65536时，这块的大小是: 65536÷8÷1024=8kb因为每秒钟，
> redis节点需要发送一定数量的ping消息作为心跳包，
> 如果槽位为65536，这个ping消息的消息头太大了，浪费带宽


- redis的集群主节点数量基本不可能超过1000个。
> 集群节点越多，心跳包的消息体内携带的数据越多,如果节点过1000个，也会导致网络拥堵

- 槽位越小，节点少的情况下，压缩率高
> Redis主节点的配置信息中，它所负责的哈希槽是通过一张bitmap的形式来保存的，
> 在传输过程中，会对bitmap进行压缩，但是如果bitmap的填充率slots / N很高的话(N表示节点数)，
> bitmap的压缩率就很低。 
> 如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。
 而16384÷8÷1024=2kb，怎么样，神奇不！



## Redis的分片机制
但是：Redis 集群没有使用一致性hash, 而是引入了`哈希槽`的概念。

Redis Cluster 采用虚拟哈希槽分区，所有的键根据哈希函数映射到 0 ~ 16383 整数槽内，
每个key通过CRC16校验后对16384取模来决定放置哪个槽(Slot)，每一个节点负责维护一部分槽以及槽所映射的键值数据。

> 计算公式：slot = CRC16(key) & 16383。

这种结构很容易添加或者删除节点，并且无论是添加删除或者修改某一个节点，都不会造成集群不可用的状态。
使用哈希槽的好处就在于可以方便的添加或移除节点。

> 当需要增加节点时，只需要把其他节点的某些哈希槽挪到新节点就可以了；

> 当需要移除节点时，只需要把移除节点上的哈希槽挪到其他节点就行了。



