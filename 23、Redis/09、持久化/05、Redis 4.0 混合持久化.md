
原文<https://www.cnblogs.com/chichung/p/12687101.html>

# Redis 4.0 混合持久化

> 如果你非常关心你的数据，建议使用 `redis 4.0` 以后的`混合持久化`特性。


重启 Redis 时，我们`很少使用 rdb `来恢复内存状态，因为会丢失大量数据。

如果使用 AOF 日志重放，性能则相对 rdb 来说要慢很多，这样在 Redis 实例很大的情况下，
启动的时候需要花费很长的时间。

Redis 4.0 为了解决这个问题，带来了一个新的持久化选项——混合持久化。


混合持久化同样也是通过`bgrewriteaof`完成的，不同的是当`开启混合持久化`时，
fork出的子进程先将共享的内存副本全量的以`RDB方式写入aof文件`，
然后在将`aof_rewrite_buf重写缓冲区`的增量命令以`AOF方式`写入到文件，
写入完成后通知主进程更新统计信息，并将新的含有RDB格式和AOF格式的AOF文件替换旧的的AOF文件。

简单的说：新的AOF文件前半段是`RDB格式`的全量数据后半段是`AOF格式`的增量数据，如下图：

> 为什么需要 AOF 重写 ?
> 随着写入命令的不断增加，AOF 文件中的内容会越来越多，文件的体积也会越来越大
> 如果不加以控制，体积过大的 AOF 文件可能会对 Redis 服务器、甚至整个宿主机造成影响，
> 并且 AOF 文件的体积越大，使用 AOF 文件来进行数据还原所需的时间就越多。



在redis重启的时候，加载 aof 文件进行恢复数据：`先加载 rdb` 内容`再加载剩余的 aof`。

![image](https://user-images.githubusercontent.com/7867225/157566401-4aa0dd4c-9b2e-4f10-a62a-ca827a89f1cd.png)


优点：结合 RDB 和 AOF 的优点, `更快的重写和恢复`。

缺点：AOF 文件里面的 RDB 部分不再是 AOF 格式，可读性差。



 

